Changes in component 'nf-neuro/segmentation/fastsurfer'
'modules/nf-neuro/segmentation/fastsurfer/environment.yml' is unchanged
'modules/nf-neuro/segmentation/fastsurfer/meta.yml' is unchanged
Changes in 'segmentation/fastsurfer/main.nf':
--- modules/nf-neuro/segmentation/fastsurfer/main.nf
+++ modules/nf-neuro/segmentation/fastsurfer/main.nf
@@ -1,10 +1,10 @@
 process SEGMENTATION_FASTSURFER {
     tag "$meta.id"
-    label 'process_single'
+    label 'process_high'
 
-    container "${ 'deepmi/fastsurfer:cpu-v2.4.2' }"
+    container "${ 'gagnonanthony/nf-pediatric-fastsurfer:v2.3.3' }"
     containerOptions {
-        (workflow.containerEngine == 'docker') ? '--entrypoint "" --user $(id -u):$(id -g)' : ''
+        (workflow.containerEngine == 'docker') ? '--entrypoint ""' : ''
     }
 
     input:
@@ -12,6 +12,7 @@
 
     output:
         tuple val(meta), path("*_fastsurfer")       , emit: fastsurferdirectory
+        tuple val(meta), path("*__final_t1.nii.gz") , emit: final_t1
         path "versions.yml"                         , emit: versions
 
     when:
@@ -25,11 +26,15 @@
     def seg_only = task.ext.seg_only ? "--seg_only" : ""
 
     def FASTSURFER_HOME = "/fastsurfer"
-    def SUBJECTS_DIR = "${prefix}_fastsurfer"
+    def SUBJECTS_DIR = "${prefix}__fastsurfer"
 
-
+    // ** Adding a registration to .gca atlas to generate the talairach.m3z file (subcortical atlas segmentation ** //
+    // ** wont work without it). A little time consuming but necessary. For FreeSurfer 7.3.2, RB_all_2020-01-02.gca ** //
+    // ** is the default atlas. Update when bumping FreeSurfer version. ** //
     """
     mkdir ${prefix}_fastsurfer/
+    export FS_LICENSE=\$(realpath $fs_license)
+
     $FASTSURFER_HOME/run_fastsurfer.sh  --allow_root \
                                         --sd \$(realpath ${SUBJECTS_DIR}) \
                                         --fs_license \$(realpath $fs_license) \
@@ -41,6 +46,13 @@
                                         $hypvinn \
                                         $seg_only \
                                         $acq3T
+
+    mri_ca_register -align-after -nobigventricles -mask ${prefix}__fastsurfer/${prefix}/mri/brainmask.mgz \
+        -T ${prefix}__fastsurfer/${prefix}/mri/transforms/talairach.lta -threads $task.cpus \
+        ${prefix}__fastsurfer/${prefix}/mri/norm.mgz \${FREESURFER_HOME}/average/RB_all_2020-01-02.gca \
+        ${prefix}__fastsurfer/${prefix}/mri/transforms/talairach.m3z
+
+    mri_convert ${prefix}__fastsurfer/${prefix}/mri/antsdn.brain.mgz ${prefix}__final_t1.nii.gz
 
     cat <<-END_VERSIONS > versions.yml
     "${task.process}":
@@ -60,6 +72,7 @@
         ${prefix}__fastsurfer/${prefix}/scripts/ \
         ${prefix}__fastsurfer/${prefix}/tmp/ \
         ${prefix}__fastsurfer/${prefix}/touch/
+    touch ${prefix}__final_t1.nii.gz
 
     cat <<-END_VERSIONS > versions.yml
     "${task.process}":

'modules/nf-neuro/segmentation/fastsurfer/tests/main.nf.test.snap' is unchanged
'modules/nf-neuro/segmentation/fastsurfer/tests/tags.yml' is unchanged
'modules/nf-neuro/segmentation/fastsurfer/tests/nextflow.config' is unchanged
'modules/nf-neuro/segmentation/fastsurfer/tests/main.nf.test' is unchanged
************************************************************
