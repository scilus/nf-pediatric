Changes in component 'nf-neuro/preproc/normalize'
'modules/nf-neuro/preproc/normalize/environment.yml' is unchanged
'modules/nf-neuro/preproc/normalize/meta.yml' is unchanged
Changes in 'preproc/normalize/main.nf':
--- modules/nf-neuro/preproc/normalize/main.nf
+++ modules/nf-neuro/preproc/normalize/main.nf
@@ -19,7 +19,7 @@
 
     script:
     def dwi_shell_tolerance = task.ext.dwi_shell_tolerance ? "--tolerance $task.ext.dwi_shell_tolerance" : ""
-    def fa_mask_threshold = task.ext.fa_mask_threshold ? "-abs $task.ext.fa_mask_threshold": ""
+    def fa_mask_threshold = meta.age < 0.5 || meta.age > 18 ? "-abs 0.10" : "-abs 0.35"
     def max_dti_shell_value = task.ext.max_dti_shell_value ?: "1600"
     def prefix = task.ext.prefix ?: "${meta.id}"
     def dti_info = task.ext.dti_shells ?: "\$(cut -d ' ' --output-delimiter=\$'\\n' -f 1- $bval | awk -F' ' '{v=int(\$1)}{if(v<=$max_dti_shell_value)print v}' | sort | uniq)"
@@ -28,6 +28,9 @@
     export ITK_GLOBAL_DEFAULT_NUMBER_OF_THREADS=$task.cpus
     export OMP_NUM_THREADS=$task.cpus
     export OPENBLAS_NUM_THREADS=1
+
+    echo "BZeroThreshold: $task.ext.dwi_shell_tolerance" > ".mrtrix.conf"
+    export MRTRIX_CONFIGFILE="./.mrtrix.conf"
 
     scil_dwi_extract_shell.py $dwi $bval $bvec $dti_info dwi_dti.nii.gz \
         bval_dti bvec_dti $dwi_shell_tolerance
@@ -39,7 +42,8 @@
         -nthreads $task.cpus
 
     dwinormalise individual $dwi ${prefix}_fa_wm_mask.nii.gz \
-        ${prefix}__dwi_normalized.nii.gz -fslgrad $bvec $bval -nthreads $task.cpus
+        ${prefix}__dwi_normalized.nii.gz -fslgrad $bvec $bval -nthreads $task.cpus \
+        -config BZeroThreshold $task.ext.dwi_shell_tolerance
 
     cat <<-END_VERSIONS > versions.yml
     "${task.process}":
@@ -49,7 +53,6 @@
     """
 
     stub:
-    def args = task.ext.args ?: ''
     def prefix = task.ext.prefix ?: "${meta.id}"
 
     """

'modules/nf-neuro/preproc/normalize/tests/main.nf.test.snap' is unchanged
'modules/nf-neuro/preproc/normalize/tests/nextflow_with_dti_shells.config' is unchanged
'modules/nf-neuro/preproc/normalize/tests/tags.yml' is unchanged
'modules/nf-neuro/preproc/normalize/tests/nextflow.config' is unchanged
'modules/nf-neuro/preproc/normalize/tests/main.nf.test' is unchanged
************************************************************
