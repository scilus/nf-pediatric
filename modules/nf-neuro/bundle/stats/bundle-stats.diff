Changes in component 'nf-neuro/bundle/stats'
'modules/nf-neuro/bundle/stats/environment.yml' is unchanged
'modules/nf-neuro/bundle/stats/meta.yml' is unchanged
Changes in 'bundle/stats/main.nf':
--- modules/nf-neuro/bundle/stats/main.nf
+++ modules/nf-neuro/bundle/stats/main.nf
@@ -2,9 +2,7 @@
     tag "$meta.id"
     label 'process_single'
 
-    container "${ workflow.containerEngine == 'singularity' && !task.ext.singularity_pull_docker_container ?
-        'https://scil.usherbrooke.ca/containers/scilus_2.0.2.sif':
-        'scilus/scilus:2.0.2' }"
+    container 'scilus/scilus:2.0.2'
 
     input:
     tuple val(meta), path(bundles), path(labels_map), path(metrics), path(lesions)
@@ -13,14 +11,14 @@
     tuple val(meta), path("*_length_stats.json")                , emit: length, optional: true
     tuple val(meta), path("*_endpoints_map_raw.json")           , emit: endpoints_raw, optional: true
     tuple val(meta), path("*_endpoints_metric_stats.json")      , emit: endpoints_metric_stats, optional: true
-    tuple val(meta), path("*_mean_std.json")                    , emit: mean_std, optional: true
+    tuple val(meta), path("*_mean_std_stats.json")              , emit: mean_std, optional: true
     tuple val(meta), path("*_volume.json")                      , emit: volume, optional: true
     tuple val(meta), path("*_volume_lesions.json")              , emit: volume_lesions, optional: true
     tuple val(meta), path("*_streamline_count.json")            , emit: streamline_count, optional: true
     tuple val(meta), path("*_streamline_count_lesions.json")    , emit: streamline_count_lesions, optional: true
     tuple val(meta), path("*_volume_per_label.json")            , emit: volume_per_labels, optional: true
     tuple val(meta), path("*_volume_per_label_lesions.json")    , emit: volume_per_labels_lesions, optional: true
-    tuple val(meta), path("*_mean_std_per_point.json")          , emit: mean_std_per_point, optional: true
+    tuple val(meta), path("*_mean_std_per_point_stats.json")    , emit: mean_std_per_point, optional: true
     tuple val(meta), path("*__lesion_stats.json")               , emit: lesion_stats, optional: true
     tuple val(meta), path("*_endpoints_map_head.nii.gz")        , emit: endpoints_head, optional: true
     tuple val(meta), path("*_endpoints_map_tail.nii.gz")        , emit: endpoints_tail, optional: true
@@ -47,11 +45,25 @@
     """
     bundles=( ${bundles.join(" ")} )
     label_map=( ${labels_map.join(" ")} )
+    metrics=( ${metrics.join(" ")} )
 
     for index in \${!bundles[@]};
-    do\
-    bname=\$(basename \${bundles[index]} .trk);
-    b_metrics="$metrics";
+    do
+    ext=\${bundles[index]#*.}
+    pos=\$((\$(echo \${bundles[index]} | grep -b -o __ | cut -d: -f1)+2))
+    bname=\${bundles[index]:\$pos}
+    bname=\$(basename \${bname} .\${ext})
+    bname=\$(echo "\${bname}" | cut -d'_' -f1-3)
+
+    # Initialize array for all relevant metrics
+    b_metrics=()
+
+    for m in \${!metrics[@]}; do
+        # Include if: matches bname OR is not an afd_fixel file
+        if [[ "\${metrics[\$m]}" == *"\${bname}"* ]] || [[ "\${metrics[\$m]}" != *"afd_fixel"* ]]; then
+            b_metrics+=("\${metrics[\$m]}")
+        fi
+    done
 
     if [[ "$length_stats" ]];
     then
@@ -66,15 +78,15 @@
             ${prefix}__\${bname}_endpoints_raw.json;
 
         scil_volume_stats_in_ROI.py ${prefix}__\${bname}_endpoints_map_head.nii.gz $normalize_weights\
-            --metrics \${b_metrics} > \${bname}_head.json
+            --metrics \${b_metrics[@]} > \${bname}_head.json
         scil_volume_stats_in_ROI.py ${prefix}__\${bname}_endpoints_map_tail.nii.gz $normalize_weights\
-            --metrics \${b_metrics} > \${bname}_tail.json;
+            --metrics \${b_metrics[@]} > \${bname}_tail.json;
 
     fi
 
     if [[ "$mean_std" ]];
     then
-        scil_bundle_mean_std.py $density_weighting \${bundles[index]} \${b_metrics} >\
+        scil_bundle_mean_std.py $density_weighting \${bundles[index]} \${b_metrics[@]} >\
             \${bname}_std.json
     fi
 
@@ -111,7 +123,7 @@
 
     if [[ "$mean_std_per_point" ]];
     then
-        scil_bundle_mean_std.py \${bundles[index]} \${b_metrics}\
+        scil_bundle_mean_std.py \${bundles[index]} \${b_metrics[@]}\
             --per_point \${label_map[index]} --sort_keys $density_weighting > \${bname}_std_per_point.json
     fi;
 
@@ -122,6 +134,7 @@
     then
         scil_json_merge_entries.py *_length.json ${prefix}_length_stats.json --add_parent_key ${prefix} \
                 --keep_separate
+        rm *_length.json
     fi
 
     #Bundle_Endpoints_Map
@@ -134,18 +147,21 @@
 
         scil_json_merge_entries.py *_tail.json *_head.json ${prefix}_endpoints_metric_stats.json \
             --no_list --add_parent_key ${prefix}
+        rm *_tail.json *_head.json *_endpoints_raw.json
     fi
 
     #Bundle_Mean_Std
     if [[ "$mean_std" ]];
     then
-        scil_json_merge_entries.py *_std.json ${prefix}_mean_std.json --no_list --add_parent_key ${prefix}
+        scil_json_merge_entries.py *_std.json ${prefix}_mean_std_stats.json --no_list --add_parent_key ${prefix}
+        rm *_std.json
     fi
 
     #Bundle_Volume
     if [[ "$volume" ]];
     then
         scil_json_merge_entries.py *_volume_stat.json ${prefix}_volume.json --no_list --add_parent_key ${prefix}
+        rm *_volume_stat.json
 
         if [[ "$lesions_stats" ]];
         then
@@ -154,6 +170,8 @@
                 --no_list --add_parent_key ${prefix}
             scil_merge_json.py ${prefix}__lesion_stats.json ${prefix}__lesion_stats.json \
                 --remove_parent_key --add_parent_key ${prefix} -f
+
+            rm *_volume_lesions_stat.json *_streamline_count_lesions_stat.json
         fi
 
     #Bundle_Streamline_Count
@@ -161,6 +179,7 @@
     then
         scil_json_merge_entries.py *_streamlines.json ${prefix}_streamline_count.json --no_list \
             --add_parent_key ${prefix}
+        rm *_streamlines.json
     fi
 
     #Bundle_Volume_Per_Label
@@ -168,19 +187,22 @@
     then
         scil_json_merge_entries.py *_volume_label.json ${prefix}_volume_per_label.json --no_list \
             --add_parent_key ${prefix}
+        rm *_volume_label.json
 
         if [[ "$lesions_stats" ]];
         then
             scil_json_merge_entries.py *_volume_per_label_lesions_stat.json ${prefix}_volume_per_label_lesions.json \
                 --no_list --add_parent_key ${prefix}
+            rm *_volume_per_label_lesions_stat.json
         fi
     fi
 
     #Bundle_Mean_Std_Per_Point
     if [[ "$mean_std_per_point" ]];
     then
-        scil_json_merge_entries.py *_std_per_point.json ${prefix}_mean_std_per_point.json --no_list \
+        scil_json_merge_entries.py *_std_per_point.json ${prefix}_mean_std_per_point_stats.json --no_list \
             --add_parent_key ${prefix}
+        rm *_std_per_point.json
     fi
 
     cat <<-END_VERSIONS > versions.yml
@@ -206,11 +228,11 @@
     touch ${prefix}__length_stats.json
     touch ${prefix}__endpoints_map_raw.json
     touch ${prefix}__endpoints_metric_stats.json
-    touch ${prefix}__mean_std.json
+    touch ${prefix}__mean_std_stats.json
     touch ${prefix}__volume.json
     touch ${prefix}__streamline_count.json
     touch ${prefix}__volume_per_label.json
-    touch ${prefix}__mean_std_per_point.json
+    touch ${prefix}__mean_std_per_point_stats.json
     touch ${prefix}_endpoints_map_head.nii.gz
     touch ${prefix}_endpoints_map_tail.nii.gz
 

'modules/nf-neuro/bundle/stats/tests/main.nf.test.snap' is unchanged
'modules/nf-neuro/bundle/stats/tests/nextflow_light.config' is unchanged
'modules/nf-neuro/bundle/stats/tests/tags.yml' is unchanged
'modules/nf-neuro/bundle/stats/tests/nextflow_lesions.config' is unchanged
'modules/nf-neuro/bundle/stats/tests/nextflow.config' is unchanged
'modules/nf-neuro/bundle/stats/tests/main.nf.test' is unchanged
************************************************************
